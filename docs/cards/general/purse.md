# 电子钱包

电子钱包起源于 EMV 标准，但时至今日，无论是在 EMV 标准，还是在中国银联的标准里，电子钱包都已被除名。尽管如此，电子钱包还是得到了极其广泛的应用，几乎所有的储值卡（特别是交通卡）都采用了电子钱包标准或与之兼容。

电子钱包使用 ISO/IEC 7816-4 协议通信，即通过收发 APDU 来交换数据。

本节介绍电子钱包特有的命令。

## 获取余额

用于读取电子钱包的余额。

命令格式：

| 数据项 | 值  |
| ------ | --- |
| CLA    | 80  |
| INS    | 5C  |
| P1     | 00  |
| P2     | 02  |
| Lc     | 无  |
| Data   | 无  |
| Le     | 04  |

该命令的响应为4字节，表示余额。

## 消费

消费分两步完成，分别是初始化消费和消费。

### 初始化消费

命令格式：

| 数据项 | 值                                              |
| ------ | ----------------------------------------------- |
| CLA    | 80                                              |
| INS    | 50                                              |
| P1     | 01                                              |
| P2     | 02                                              |
| Lc     | 0B                                              |
| Data   | 1字节密钥索引 + 4字节交易金额 + 6字节终端机编号 |
| Le     | 04                                              |

命令响应：

| 说明       | 长度 |
| ---------- | ---- |
| 旧余额     | 4    |
| 交易序号   | 2    |
| 透支限额   | 3    |
| 密钥版本号 | 1    |
| 算法标识   | 1    |
| 随机数     | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9401   | 余额不足         |
| 9403   | 密钥索引不支持   |
| 9303   | 应用已被永久锁定 |

### 消费

当初始化消费完成后，终端和卡将分别计算消息验证码，计算方法如下：

1. 拼接数据 data 为：初始化消费返回的4字节随机数 + 初始化消费返回的2字节交易序号 + 终端交易序号的最右2字节
2. 使用初始化消费指定的密钥索引对应的消费密钥 DPK 对 data 使用 3DES 算法加密，得到过程密钥 SESPK
3. 使用 SESPK 对如下数据计算 MAC 作为 MAC1：4字节交易金额 + 06 + 6字节终端机编号 + 7字节交易日期时间
4. 使用 SESPK 对交易金额计算 MAC 作为 MAC2
5. 使用 TAC 密钥 DTK 对如下数据计算 MAC 作为 TAC：4字节交易金额 + 06 + 6字节终端机编号 + 4字节终端交易序号 + 7字节交易日期时间

| 数据项 | 值                                           |
| ------ | -------------------------------------------- |
| CLA    | 80                                           |
| INS    | 54                                           |
| P1     | 01                                           |
| P2     | 00                                           |
| Lc     | 0F                                           |
| Data   | 4字节终端交易序号 + 7字节交易日期时间 + MAC1 |
| Le     | 08                                           |

命令响应：

| 说明 | 长度 |
| ---- | ---- |
| TAC  | 4    |
| MAC2 | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9301   | 余额不足         |
| 9302   | MAC 无效         |
| 9303   | 应用已被永久锁定 |

## 圈存
