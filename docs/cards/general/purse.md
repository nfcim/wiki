# 电子钱包

电子钱包起源于 EMV 标准，但时至今日，无论是在 EMV 标准，还是在中国银联的标准里，电子钱包都已被除名。尽管如此，电子钱包还是得到了极其广泛的应用，几乎所有的储值卡（特别是交通卡）都采用了电子钱包标准或与之兼容。

电子钱包使用 ISO/IEC 7816-4 协议通信，即通过收发 APDU 来交换数据。

本节介绍电子钱包特有的命令。

## 获取余额

用于读取电子钱包的余额。

命令格式：

| 数据项 | 值  |
| ------ | --- |
| CLA    | 80  |
| INS    | 5C  |
| P1     | 00  |
| P2     | 02  |
| Lc     | 无  |
| Data   | 无  |
| Le     | 04  |

该命令的响应为4字节，表示余额。

## 消费

消费分两步完成，分别是初始化消费和消费。

### 初始化消费

命令格式：

| 数据项 | 值                                              |
| ------ | ----------------------------------------------- |
| CLA    | 80                                              |
| INS    | 50                                              |
| P1     | 01                                              |
| P2     | 02                                              |
| Lc     | 0B                                              |
| Data   | 1字节密钥索引 + 4字节交易金额 + 6字节终端机编号 |
| Le     | 0F                                              |

命令响应：

| 说明       | 长度 |
| ---------- | ---- |
| 旧余额     | 4    |
| 交易序号   | 2    |
| 透支限额   | 3    |
| 密钥版本号 | 1    |
| 算法标识   | 1    |
| 随机数     | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9401   | 余额不足         |
| 9403   | 密钥索引不支持   |
| 9303   | 应用已被永久锁定 |

### 消费

当初始化消费完成后，终端和卡将分别计算消息验证码，计算方法如下：

1. 拼接数据 data 为：初始化消费返回的4字节随机数 + 初始化消费返回的2字节交易序号 + 终端交易序号的最右2字节
2. 使用初始化消费指定的密钥索引对应的消费密钥 DPK 对 data 使用 3DES 算法加密，得到过程密钥 SESPK
3. 使用 SESPK 对如下数据计算 MAC 作为 MAC1：4字节交易金额 + 06 + 6字节终端机编号 + 7字节交易日期时间
4. 使用 SESPK 对交易金额计算 MAC 作为 MAC2
5. 使用 TAC 密钥 DTK 左右8字节异或结果对如下数据计算 MAC 作为 TAC：4字节交易金额 + 06 + 6字节终端机编号 + 4字节终端交易序号 + 7字节交易日期时间

| 数据项 | 值                                           |
| ------ | -------------------------------------------- |
| CLA    | 80                                           |
| INS    | 54                                           |
| P1     | 01                                           |
| P2     | 00                                           |
| Lc     | 0F                                           |
| Data   | 4字节终端交易序号 + 7字节交易日期时间 + MAC1 |
| Le     | 08                                           |

命令响应：

| 说明 | 长度 |
| ---- | ---- |
| TAC  | 4    |
| MAC2 | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9301   | 余额不足         |
| 9302   | MAC 无效         |
| 9303   | 应用已被永久锁定 |

## 圈存

与消费类似，圈存也分两步完成，分别是初始化圈存和圈存。

### 初始化圈存

命令格式：

| 数据项 | 值                                              |
| ------ | ----------------------------------------------- |
| CLA    | 80                                              |
| INS    | 50                                              |
| P1     | 00                                              |
| P2     | 02                                              |
| Lc     | 0B                                              |
| Data   | 1字节密钥索引 + 4字节交易金额 + 6字节终端机编号 |
| Le     | 10                                              |

命令响应：

| 说明       | 长度 |
| ---------- | ---- |
| 旧余额     | 4    |
| 交易序号   | 2    |
| 密钥版本号 | 1    |
| 算法标识   | 1    |
| 随机数     | 4    |
| MAC1       | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9403   | 密钥索引不支持   |
| 9303   | 应用已被永久锁定 |

### 圈存

当初始化圈存完成后，终端和卡将分别计算消息验证码，计算方法如下：

1. 拼接数据 data 为：初始化消费返回的4字节随机数 + 初始化消费返回的2字节交易序号 + 8000
2. 使用初始化圈存指定的密钥索引对应的圈存密钥 DLK 对 data 使用 3DES 算法加密，得到过程密钥 SESLK
3. 使用 SESLK 对如下数据计算 MAC 作为 MAC1：4字节旧余额 + 4字节交易金额 + 02 + 6字节终端机编号
4. 使用 SESLK 对如下数据计算 MAC 作为 MAC2：4字节交易金额 + 02 + 6字节终端机编号 + 4字节终端交易序号 + 7字节交易日期时间
5. 使用 TAC 密钥 DTK 左右8字节异或结果对如下数据计算 MAC 作为 TAC：4字节新余额 + 2字节交易序号（加1前） + 4字节交易金额 + 02 + 6字节终端机编号 + 7字节交易日期时间

| 数据项 | 值                       |
| ------ | ------------------------ |
| CLA    | 80                       |
| INS    | 52                       |
| P1     | 00                       |
| P2     | 00                       |
| Lc     | 0B                       |
| Data   | 7字节交易日期时间 + MAC2 |
| Le     | 04                       |

命令响应：

| 说明 | 长度 |
| ---- | ---- |
| TAC  | 4    |

如果响应出错，则可能的错误码包括：

| 错误码 | 说明             |
| ------ | ---------------- |
| 9302   | MAC 无效         |
| 9303   | 应用已被永久锁定 |

## 电子钱包中的密钥

本节余下部分介绍电子钱包中的密钥关系和部分用法。

### 密钥关系表

| 密钥 | 发卡方         | IC卡                                        | POS（PSAM） |
| ---- | -------------- | ------------------------------------------- | ----------- |
| 消费 | 消费主密钥 MPK | 消费子密钥 DPK，由 MPK 用应用序列号推导得到 | MPK         |
| 圈存 | 圈存主密钥 MLK | 圈存子密钥 DLK，由 MLK 用应用序列号推导得到 | N/A         |
| TAC  | TAC 主密钥 MTK | TAC 子密钥 DTK，由 MTK 用应用序列号推导得到 | N/A         |

### 子密钥推导算法

#### 子密钥左半部分推导方法

1. 将应用序列号的最右16个数字作为输入
2. 将主密钥作为加密密钥
3. 用加密密钥对输入数据执行 3DES 加密运算

#### 子密钥右半部分推导方法

1. 将应用序列号的最右16个数字取反作为输入
2. 将主密钥作为加密密钥
3. 用加密密钥对输入数据执行 3DES 加密运算

### MAC / TAC 的计算方法

1. 使用8字节的 `00` 作为初始化向量（IV）
2. 将输入数据按8字节切块，最后一个块的长度：
    - 为8字节，则补一个块，内容为 `80 00 00 00 00 00 00 00`
    - 不足8字节，则补`80`，若还不足8字节，继续补`00`直到8字节
3. 使用过程密钥对上述分块执行 DES-CBC 加密操作
4. 取加密结果的左4字节作为 MAC 或 TAC