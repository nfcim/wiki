# 北京市政交通一卡通 

## 卡片结构

``` mermaid
graph TD
    mf[[MF<br>AID=325041592E5359532E4444463031<br>DF-ID=0x3F00]] --> issue[发行信息<br>SFI=0x04]
    mf --> basic[基本信息<br>SFI=0x05]
    mf --> purse[[钱包应用<br>EF-ID=0x1001]]
    purse --> topup[充值记录<br>SFI=0x13]
    purse --> bus[公交数据<br>SFI=0x14]
    purse --> metro[地铁数据<br>SFI=0x15]
    purse --> trans[交易明细<br>SFI=0x18]
```

## 文件结构

### MF
#### 发行基本信息文件

| 基本属性 | 值             |
| -------- | -------------- |
| SFI      | 0x04           |
| 文件类型 | 二进制         |
| 文件大小 | 0x3C           |
| 权限     | 读=自由，写=SM |

| 字节  | 数据元   | 长度 | 数据类型 | 备注     |
| ----- | -------- | ---- | -------- | -------- |
| 1-8   | 卡号     | 8    | BCD      |
| 9-24  | 不详     | 15   | N/A      |
| 25-28 | 发行日期 | 4    | BCD      | YYYYMMDD |
| 29-32 | 失效日期 | 4    | BCD      | YYYYMMDD |
| 33-60 | 不详     | 28   | N/A      |

#### 公共基本信息文件

| 基本属性 | 值             |
| -------- | -------------- |
| SFI      | 0x05           |
| 文件类型 | 二进制         |
| 文件大小 | 0x20           |
| 权限     | 读=自由，写=SM |

| 字节   | 数据元       | 长度 | 数据类型 | 备注 |
| ------ | ------------ | ---- | -------- | ---- |
| 1 - 3  | 透支金额     | 3    | HEX      |
| 4 - 5  | 累计交易计数 | 2    | HEX      |
| 6 - 32 | 不详         | 27   | N/A      |

### 钱包应用

#### 充值记录文件

| 基本属性 | 值             |
| -------- | -------------- |
| SFI      | 0x13           |
| 文件类型 | 循环记录       |
| 记录数量 | 3              |
| 记录长度 | 0x17           |
| 权限     | 读=自由，写=SM |

| 字节  | 数据元       | 长度 | 数据类型 | 备注   |
| ----- | ------------ | ---- | -------- | ------ |
| 1-3   | 充值前金额   | 3    | HEX      |
| 4-6   | 充值后金额   | 3    | HEX      |
| 7-8   | 不详         | 2    | N/A      |
| 9-11  | 充值日期     | 3    | BCD      | YYMMDD |
| 12-17 | 交易终端编号 | 6    | HEX      |
| 18-23 | 不详         | 6    | N/A      |

#### 公交过程数据文件

| 基本属性 | 值             |
| -------- | -------------- |
| SFI      | 0x14           |
| 文件类型 | 二进制         |
| 文件大小 | 0x18           |
| 权限     | 读=自由，写=SM |

| 字节    | 数据元   | 长度 | 数据类型 | 备注         |
| ------- | -------- | ---- | -------- | ------------ |
| 1 - 6   | 上车时间 | 6    | BCD      | YYMMDDhhmmss |
| 7       | 方向     | 1    | HEX      | AB 或 BA     |
| 8-9     | 不详     | 2    | HEX      |
| 10 - 11 | 线路     | 2    | HEX      | 小端序       |
| 12-24   | 不详     | 13   | N/A      |

#### 地铁过程数据文件

| 基本属性 | 值             |
| -------- | -------------- |
| SFI      | 0x15           |
| 文件类型 | 二进制         |
| 文件大小 | 0x32           |
| 权限     | 读=自由，写=SM |

| 字节    | 数据元         | 长度 | 数据类型 | 备注         |
| ------- | -------------- | ---- | -------- | ------------ |
| 1 - 5   | 进站时间       | 5    | BCD      | YYMMDDhhmm   |
| 6       | 入口线路编号   | 1    | HEX      |
| 7       | 入口站编号     | 1    | HEX      |
| 8       | 不详           | 1    | N/A      | 01，存疑     |
| 9 - 10  | 入口时钱包余额 | 2    | HEX      | 小端序       |
| 11-15   | 不详           | 5    | N/A      |
| 16 - 20 | 出站时间       | 5    | BCD      | YYMMDDhhmm   |
| 21      | 出口线路编号   | 1    | HEX      |
| 22      | 出口站编号     | 1    | HEX      |
| 23      | 不详           | 1    | HEX      | 02，存疑     |
| 24-27   | 不详           | 4    | HEX      | 全0          |
| 28-29   | 标注金额       | 2    | HEX      | 小端序       |
| 30-37   | 不详           | 8    | N/A      |
| 38-40   | 最近乘坐日期   | 3    | BCD      | YYMMDD，存疑 |
| 41-42   | 该月累计金额   | 2    | HEX      | 小端序       |
| 43-50   | 不详           | 8    | N/A      |

#### 交易明细记录文件

| 基本属性 | 值       |
| -------- | -------- |
| SFI      | 0x18     |
| 文件类型 | 循环记录 |
| 记录数量 | 10       |
| 记录长度 | 0x17     |
| 权限     | 读=自由  |

| 字节  | 数据元       | 长度 | 数据类型 | 备注               |
| ----- | ------------ | ---- | -------- | ------------------ |
| 1-2   | 交易计数     | 2    | HEX      |
| 3-5   | 预留         | 3    | HEX      |
| 6-9   | 交易金额     | 4    | HEX      |
| 10    | 交易类型     | 1    | HEX      | 06为消费，02为充值 |
| 11-16 | 交易终端编号 | 6    | BCD      |
| 17-23 | 交易时间     | 7    | BCD      | YYYYMMDDhhmm       |

### 地铁线路数据

交易终端以`300`开头的，表示地铁的终端设备。
第4、5位为地铁线路编号，例如 `300040000570` 的 `04` 表示编号。

| 编号 | 线路       |
| ---- | ---------- |
| 01   | 一号线     |
| 02   | 二号线     |
| 04   | 四号线     |
| 05   | 五号线     |
| 06   | 六号线     |
| 07   | 七号线     |
| 08   | 八号线     |
| 09   | 九号线     |
| 10   | 十号线     |
| 13   | 十三号线   |
| 14   | 十四号线   |
| 15   | 十五号线   |
| 18   | 西郊线     |
| 88   | 大兴机场线 |
| 93   | 大兴线     |
| 94   | 昌平线     |
| 95   | 房山线     |
| 96   | 亦庄线     |
| 97   | 八通线     |
| 98   | 机场线     |

## 备注

1. 由于 MF 默认选中，因此读卡器不会发送 `SELECT` 命令，但如果手动发送 `SELECT` 命令，该卡也会接受。
2. 由于该卡接受的 AID 为 PPSE，因此在目前的 iOS 上无法读取。